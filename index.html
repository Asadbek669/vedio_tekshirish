<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Professional video URL tekshiruvchi - streaming va video fayllar mavjudligini tekshirish" />
  <title>Professional Video URL Tekshiruvchi</title>

  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1724;
      --muted: #98b0c9;
      --accent: #4f46e5;
      --good: #10b981;
      --bad: #ef4444;
      --warn: #f59e0b;
      --glass: rgba(255, 255, 255, 0.03);
      --max-width: 980px;
      --radius: 12px;
      --transition: all 0.2s ease;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', ui-sans-serif, system-ui, sans-serif;
      background: linear-gradient(180deg, var(--bg), #071024);
      color: #e6eef8;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 36px 18px;
      line-height: 1.5;
    }
    
    .container {
      width: 100%;
      max-width: var(--max-width);
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    header {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    h1 {
      font-size: 22px;
      margin: 0;
      background: linear-gradient(90deg, #e6eef8, #98b0c9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    p.lead {
      margin: 8px 0 0 0;
      color: var(--muted);
      font-size: 14px;
    }
    
    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
      backdrop-filter: blur(10px);
    }
    
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    input[type="url"] {
      flex: 1;
      min-width: 300px;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: rgba(255, 255, 255, 0.03);
      color: inherit;
      outline: none;
      font-size: 14px;
      transition: var(--transition);
    }
    
    input[type="url"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    input[type="url"]::placeholder {
      color: rgba(152, 176, 201, 0.5);
    }
    
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      transition: var(--transition);
      font-size: 14px;
    }
    
    button:hover:not(:disabled) {
      background: #4338ca;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--muted);
    }
    
    button.secondary {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: var(--muted);
      font-weight: 600;
      padding: 10px 12px;
    }
    
    button.secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
      color: white;
    }
    
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      margin-top: 24px;
    }
    
    .panel {
      background: var(--card);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      transition: var(--transition);
    }
    
    .panel:hover {
      border-color: rgba(255, 255, 255, 0.08);
    }
    
    .logs {
      height: 320px;
      overflow: auto;
      background: linear-gradient(180deg, #071026, #05101b);
      padding: 16px;
      border-radius: 8px;
      font-family: 'JetBrains Mono', 'Cascadia Code', 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .status {
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    
    .good {
      background: rgba(16, 185, 129, 0.15);
      color: var(--good);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .bad {
      background: rgba(239, 68, 68, 0.12);
      color: var(--bad);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .warn {
      background: rgba(245, 158, 11, 0.12);
      color: var(--warn);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .info {
      background: rgba(79, 70, 229, 0.12);
      color: var(--accent);
      border: 1px solid rgba(79, 70, 229, 0.3);
    }
    
    .field {
      margin-top: 16px;
    }
    
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    
    .mini {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .probeVideo {
      width: 100%;
      max-height: 240px;
      background: #000;
      border-radius: 8px;
      display: block;
    }
    
    footer {
      margin-top: 24px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .toggle {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
    }
    
    label.switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    
    label.switch input {
      display: none;
    }
    
    label.switch .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #263143;
      border-radius: 999px;
      transition: 0.2s;
    }
    
    label.switch .knob {
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      top: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.2s;
    }
    
    label.switch input:checked + .slider {
      background: var(--accent);
    }
    
    label.switch input:checked + .slider .knob {
      transform: translateX(24px);
    }
    
    select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
      cursor: pointer;
    }
    
    select:focus {
      border-color: var(--accent);
    }
    
    .progress-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 2px;
      margin-top: 12px;
      overflow: hidden;
      position: relative;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #8b5cf6);
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .stat-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }
    
    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    @media (max-width: 980px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .row {
        flex-direction: column;
      }
      input[type="url"] {
        min-width: 100%;
      }
      button {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media (max-width: 640px) {
      body {
        padding: 20px 12px;
      }
      .card {
        padding: 16px;
      }
      .main-grid {
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="flex: 1">
        <h1>üé¨ Professional Video URL Tekshiruvchi</h1>
        <p class="lead">Streaming va video fayllar mavjudligini tekshirish: HEAD ‚Üí Range GET ‚Üí Video test. Aniq natijalar uchun server proxy ishlating.</p>
      </div>
    </header>

    <div class="card">
      <div class="row">
        <input 
          id="url" 
          type="url" 
          placeholder="https://cdn.example.com/video.mp4 yoki https://stream.example.com/hls/playlist.m3u8" 
          autocomplete="off" 
          spellcheck="false"
        />
        <button id="checkBtn">
          <span id="checkIcon">üîç</span>
          <span id="checkText">Tekshirish</span>
        </button>
        <button id="openBtn" class="secondary" disabled>
          <span>‚ÜóÔ∏è</span>
          <span>Ochish</span>
        </button>
        <button id="downloadBtn" class="secondary" disabled>
          <span>üì•</span>
          <span>Yuklab olish</span>
        </button>
      </div>

      <div class="controls">
        <div class="toggle">
          <label class="switch">
            <input id="useProxy" type="checkbox">
            <span class="slider"><span class="knob"></span></span>
          </label>
          <div class="small">Server proxy ishlatish (tavsiya etiladi)</div>
        </div>

        <div class="field small" style="display: flex; align-items: center; gap: 8px;">
          <span>Video test muddati:</span>
          <select id="timeoutSelect" class="small">
            <option value="2000">2s</option>
            <option value="3000" selected>3s</option>
            <option value="5000">5s</option>
            <option value="8000">8s</option>
            <option value="10000">10s</option>
          </select>
        </div>

        <div class="field small" style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
          <span>Test turi:</span>
          <select id="testType" class="small">
            <option value="auto" selected>Avtomatik</option>
            <option value="head">Faqat HEAD</option>
            <option value="range">Faqat Range GET</option>
            <option value="video">Faqat Video test</option>
            <option value="full">To'liq tekshiruv</option>
          </select>
        </div>
      </div>

      <div class="progress-bar" style="display: none;">
        <div class="progress" id="progress"></div>
      </div>

      <div class="main-grid">
        <div>
          <div class="panel">
            <div class="status" id="summary">
              <span id="statusIcon">‚úÖ</span>
              <span id="statusText">Tayyor</span>
            </div>

            <div id="details" class="small">
              <div><strong>Oxirgi tekshiruv:</strong> <span id="lastCheck">‚Äî</span></div>
              <div><strong>Tekshiruv rejimi:</strong> <span id="probeMode">Avtomatik (HEAD ‚Üí Range ‚Üí Video)</span></div>
              <div><strong>Test davomiyligi:</strong> <span id="testDuration">‚Äî</span></div>
            </div>

            <div class="stats">
              <div class="stat-item">
                <div class="stat-value" id="headStatus">‚Äî</div>
                <div class="stat-label">HEAD Status</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="rangeStatus">‚Äî</div>
                <div class="stat-label">Range Status</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="videoStatus">‚Äî</div>
                <div class="stat-label">Video Status</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalTime">0ms</div>
                <div class="stat-label">Umumiy vaqt</div>
              </div>
            </div>

            <div class="field">
              <div class="small"><strong>HTTP ma'lumotlari</strong></div>
              <div id="httpInfo" class="mini">
                <span class="small">Hali ma'lumot yo'q</span>
              </div>
            </div>

            <div class="field">
              <div class="small"><strong>Video tekshiruv natijasi</strong></div>
              <div id="probeResult" class="mini">
                <span class="small">Hali tekshirilmagan</span>
              </div>
            </div>

            <div class="field">
              <div class="small"><strong>Tavsiyalar</strong></div>
              <div id="recommend" class="mini">
                <span class="small">URL kiriting va "Tekshirish" tugmasini bosing</span>
              </div>
            </div>
          </div>

          <div style="margin-top: 20px" class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <strong>üé• Jonli video testi</strong>
              <div class="small">Video testi ishga tushganda ko'rinadi</div>
            </div>
            <div id="videoHolder" style="margin-top: 12px; display: none">
              <video id="probeVideo" class="probeVideo" controls muted playsinline></video>
              <div class="mini" style="margin-top: 8px">
                <span>Video formati: <span id="videoFormat">‚Äî</span></span>
                <span>Video o'lchami: <span id="videoSize">‚Äî</span></span>
                <span>Davomiyligi: <span id="videoDuration">‚Äî</span></span>
              </div>
            </div>
          </div>
        </div>

        <aside>
          <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <strong>üìä Loglar</strong>
              <div class="small">Real vaqt diagnostikasi</div>
            </div>
            <div id="logs" class="logs" aria-live="polite">‚úÖ Tayyor. URL kiriting va tekshiruvni boshlang.</div>
            <div style="margin-top: 12px; display: flex; gap: 8px">
              <button id="copyLog" class="secondary">üìã Logni nusxalash</button>
              <button id="clearLog" class="secondary">üóëÔ∏è Tozalash</button>
              <button id="exportLog" class="secondary">üì§ Export</button>
            </div>
          </div>

          <div class="panel" style="margin-top: 16px">
            <div class="small"><strong>‚öôÔ∏è Proxy sozlamalari</strong></div>
            <div class="small" style="margin-top: 8px">
              CORS cheklovlarini chetlab o'tish uchun server proxy ishlating.
            </div>
            <div style="margin-top: 12px" class="mini">
              <label class="small" style="display: block; margin-bottom: 6px">Proxy URL:</label>
              <input 
                id="proxyUrl" 
                class="small" 
                placeholder="http://localhost:3000/proxy?url=" 
                style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); color: white; padding: 8px 12px; border-radius: 8px; width: 100%; font-size: 13px;"
              />
            </div>
            <div class="mini" style="margin-top: 12px; display: flex; gap: 8px">
              <button id="testProxy" class="secondary" style="flex: 1; font-size: 12px;">Proxy test</button>
              <button id="saveSettings" class="secondary" style="flex: 1; font-size: 12px;">Sozlamalarni saqlash</button>
            </div>
          </div>

          <div class="panel" style="margin-top: 16px">
            <div class="small"><strong>üìà Statistika</strong></div>
            <div class="mini" style="margin-top: 8px">
              <div>Bugungi tekshiruvlar: <span id="todayChecks">0</span></div>
              <div>Muvaffaqiyatli: <span id="successChecks">0</span></div>
              <div>Muvaffaqiyatsiz: <span id="failedChecks">0</span></div>
              <div>O'rtacha vaqt: <span id="avgTime">0ms</span></div>
            </div>
          </div>
        </aside>
      </div>

      <footer>
        <div>¬© 2024 Video Tekshiruvchi v2.0</div>
        <div class="small" style="margin-top: 4px">
          HLS, MP4, WebM, MOV formatlari qo'llab-quvvatlanadi. Aniq natijalar uchun server proxy ishlating.
        </div>
      </footer>
    </div>
  </div>

  <script>
    (function(){
      const urlInput = document.getElementById('url');
      const checkBtn = document.getElementById('checkBtn');
      const openBtn = document.getElementById('openBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const useProxy = document.getElementById('useProxy');
      const proxyUrl = document.getElementById('proxyUrl');
      const logs = document.getElementById('logs');
      const summary = document.getElementById('summary');
      const statusIcon = document.getElementById('statusIcon');
      const statusText = document.getElementById('statusText');
      const httpInfo = document.getElementById('httpInfo');
      const probeResult = document.getElementById('probeResult');
      const recommend = document.getElementById('recommend');
      const lastCheck = document.getElementById('lastCheck');
      const testDuration = document.getElementById('testDuration');
      const videoHolder = document.getElementById('videoHolder');
      const probeVideo = document.getElementById('probeVideo');
      const timeoutSelect = document.getElementById('timeoutSelect');
      const testType = document.getElementById('testType');
      const copyLog = document.getElementById('copyLog');
      const clearLog = document.getElementById('clearLog');
      const exportLog = document.getElementById('exportLog');
      const testProxy = document.getElementById('testProxy');
      const saveSettings = document.getElementById('saveSettings');
      const progressBar = document.querySelector('.progress-bar');
      const progress = document.getElementById('progress');
      
      // Stats elements
      const headStatus = document.getElementById('headStatus');
      const rangeStatus = document.getElementById('rangeStatus');
      const videoStatus = document.getElementById('videoStatus');
      const totalTime = document.getElementById('totalTime');
      const videoFormat = document.getElementById('videoFormat');
      const videoSize = document.getElementById('videoSize');
      const videoDuration = document.getElementById('videoDuration');
      
      // Statistics
      const todayChecks = document.getElementById('todayChecks');
      const successChecks = document.getElementById('successChecks');
      const failedChecks = document.getElementById('failedChecks');
      const avgTime = document.getElementById('avgTime');
      
      let isChecking = false;
      let checkStartTime = 0;
      let checkHistory = [];
      
      // Initialize from localStorage
      function loadSettings() {
        const saved = localStorage.getItem('videoCheckerSettings');
        if (saved) {
          const settings = JSON.parse(saved);
          proxyUrl.value = settings.proxyUrl || 'http://localhost:3000/proxy?url=';
          useProxy.checked = settings.useProxy || false;
          timeoutSelect.value = settings.timeout || '3000';
          testType.value = settings.testType || 'auto';
        }
        updateStats();
      }
      
      function saveSettingsToStorage() {
        const settings = {
          proxyUrl: proxyUrl.value,
          useProxy: useProxy.checked,
          timeout: timeoutSelect.value,
          testType: testType.value,
          lastUsed: new Date().toISOString()
        };
        localStorage.setItem('videoCheckerSettings', JSON.stringify(settings));
        appendLog('Sozlamalar saqlandi');
      }
      
      function updateStats() {
        const stats = JSON.parse(localStorage.getItem('videoCheckerStats') || '{}');
        const today = new Date().toDateString();
        
        if (!stats[today]) {
          stats[today] = { total: 0, success: 0, failed: 0, totalTime: 0 };
        }
        
        const todayStats = stats[today];
        todayChecks.textContent = todayStats.total;
        successChecks.textContent = todayStats.success;
        failedChecks.textContent = todayStats.failed;
        avgTime.textContent = todayStats.total > 0 ? 
          Math.round(todayStats.totalTime / todayStats.total) + 'ms' : '0ms';
      }
      
      function recordCheck(success, duration) {
        const today = new Date().toDateString();
        const stats = JSON.parse(localStorage.getItem('videoCheckerStats') || '{}');
        
        if (!stats[today]) {
          stats[today] = { total: 0, success: 0, failed: 0, totalTime: 0 };
        }
        
        stats[today].total++;
        if (success) {
          stats[today].success++;
        } else {
          stats[today].failed++;
        }
        stats[today].totalTime += duration;
        
        localStorage.setItem('videoCheckerStats', JSON.stringify(stats));
        updateStats();
      }
      
      function now() { 
        return new Date().toLocaleString('uz-UZ', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      }
      
      function appendLog(msg, type = 'info') {
        const t = new Date().toLocaleTimeString();
        const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        logs.innerHTML = `<span style="color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warn' ? '#f59e0b' : '#98b0c9'}">[${t}] ${icon} ${msg}</span><br>` + logs.innerHTML;
        logs.scrollTop = 0;
      }
      
      function updateProgress(percent) {
        progressBar.style.display = 'block';
        progress.style.width = percent + '%';
      }
      
      function setStatus(text, type = 'info') {
        statusText.textContent = text;
        summary.className = 'status ' + type;
        
        const icons = {
          good: '‚úÖ',
          bad: '‚ùå',
          warn: '‚ö†Ô∏è',
          info: 'üîÑ'
        };
        statusIcon.textContent = icons[type] || '‚ÑπÔ∏è';
      }
      
      function updateStatsDisplay(stats) {
        headStatus.textContent = stats.head || '‚Äî';
        headStatus.style.color = stats.head >= 200 && stats.head < 300 ? '#10b981' : 
                                stats.head === 403 ? '#ef4444' : 
                                stats.head ? '#f59e0b' : '#98b0c9';
        
        rangeStatus.textContent = stats.range || '‚Äî';
        rangeStatus.style.color = (stats.range >= 200 && stats.range < 300) || stats.range === 206 ? '#10b981' : 
                                 stats.range === 403 ? '#ef4444' : 
                                 stats.range ? '#f59e0b' : '#98b0c9';
        
        videoStatus.textContent = stats.video || '‚Äî';
        videoStatus.style.color = stats.video === 'OK' ? '#10b981' : 
                                 stats.video === 'ERROR' ? '#ef4444' : 
                                 stats.video === 'TIMEOUT' ? '#f59e0b' : '#98b0c9';
      }
      
      async function fetchWithTimeout(url, opts = {}, timeout = 4000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const res = await fetch(url, { ...opts, signal: controller.signal });
          clearTimeout(id);
          return res;
        } catch (e) {
          clearTimeout(id);
          throw e;
        }
      }
      
      async function performChecks(url) {
        if (isChecking) return;
        
        isChecking = true;
        checkStartTime = Date.now();
        checkBtn.disabled = true;
        checkBtn.innerHTML = 'üîÑ Tekshirilmoqda...';
        setStatus('Tekshirilmoqda...', 'info');
        
        // Reset display
        updateStatsDisplay({});
        httpInfo.innerHTML = '<span class="small">Tekshirilmoqda...</span>';
        probeResult.innerHTML = '<span class="small">Tekshirilmoqda...</span>';
        recommend.innerHTML = '<span class="small">Kuting...</span>';
        videoHolder.style.display = 'none';
        probeVideo.src = '';
        progressBar.style.display = 'block';
        progress.style.width = '0%';
        
        const proxyEnabled = useProxy.checked && proxyUrl.value.trim();
        const selectedTestType = testType.value;
        const stats = {};
        let finalResult = 'unknown';
        
        appendLog('Tekshiruv boshlandi: ' + url);
        
        async function proxyFetch(target, method = 'HEAD', timeout = 4000) {
          const p = proxyUrl.value.trim();
          if (!p) throw new Error('Proxy sozlanmagan');
          const u = p + encodeURIComponent(target) + '&_method=' + method;
          return fetchWithTimeout(u, { method: 'GET' }, timeout);
        }
        
        try {
          // HEAD test
          if (selectedTestType === 'auto' || selectedTestType === 'full' || selectedTestType === 'head') {
            updateProgress(20);
            appendLog('HEAD so\'rovi yuborilmoqda...');
            try {
              let res;
              if (proxyEnabled) {
                res = await proxyFetch(url, 'HEAD', 4000);
              } else {
                res = await fetchWithTimeout(url, { method: 'HEAD', mode: 'no-cors' }, 4000);
              }
              stats.head = res.status;
              appendLog(`HEAD natija: ${res.status} ${res.statusText}`);
              
              if (res.status === 200 || res.status === 206) {
                finalResult = 'available';
              }
            } catch (e) {
              appendLog(`HEAD xato: ${e.message}`, 'error');
              stats.head = 'ERROR';
            }
          }
          
          // Range GET test
          if (selectedTestType === 'auto' || selectedTestType === 'full' || selectedTestType === 'range') {
            updateProgress(50);
            appendLog('Range GET so\'rovi yuborilmoqda...');
            try {
              let res;
              if (proxyEnabled) {
                res = await proxyFetch(url, 'GET', 5000);
              } else {
                res = await fetchWithTimeout(url, { 
                  method: 'GET', 
                  headers: { 'Range': 'bytes=0-1023' },
                  mode: 'no-cors'
                }, 5000);
              }
              stats.range = res.status;
              appendLog(`Range GET natija: ${res.status} ${res.statusText}`);
              
              if (res.status === 200 || res.status === 206) {
                finalResult = 'available';
              } else if (res.status === 403) {
                finalResult = 'blocked';
              }
            } catch (e) {
              appendLog(`Range GET xato: ${e.message}`, 'error');
              stats.range = 'ERROR';
            }
          }
          
          // Video test
          if (selectedTestType === 'auto' || selectedTestType === 'full' || selectedTestType === 'video') {
            updateProgress(80);
            appendLog('Video testi boshlandi...');
            
            const probeTimeout = parseInt(timeoutSelect.value, 10) || 3000;
            videoHolder.style.display = 'block';
            probeVideo.src = url;
            probeVideo.crossOrigin = 'anonymous';
            probeVideo.preload = 'metadata';
            
            try {
              const videoResult = await new Promise((resolve) => {
                let done = false;
                const t = setTimeout(() => {
                  if (done) return;
                  done = true;
                  probeVideo.pause();
                  probeVideo.removeAttribute('src');
                  probeVideo.load();
                  resolve('TIMEOUT');
                }, probeTimeout);
                
                probeVideo.onloadedmetadata = () => {
                  if (done) return;
                  done = true;
                  clearTimeout(t);
                  
                  // Get video info
                  videoFormat.textContent = probeVideo.videoWidth + 'x' + probeVideo.videoHeight;
                  videoDuration.textContent = probeVideo.duration ? probeVideo.duration.toFixed(1) + 's' : '‚Äî';
                  
                  // Try to get file size
                  if (probeVideo.duration && probeVideo.videoWidth) {
                    videoSize.textContent = 'Mavjud';
                  }
                  
                  resolve('OK');
                };
                
                probeVideo.onerror = (e) => {
                  if (done) return;
                  done = true;
                  clearTimeout(t);
                  resolve('ERROR');
                };
              });
              
              stats.video = videoResult;
              appendLog(`Video test natija: ${videoResult}`);
              
              if (videoResult === 'OK') {
                finalResult = 'playable';
              }
            } catch (e) {
              appendLog(`Video test xato: ${e.message}`, 'error');
              stats.video = 'ERROR';
            }
          }
          
          updateProgress(100);
          const totalDuration = Date.now() - checkStartTime;
          
          // Update UI based on final result
          updateStatsDisplay(stats);
          totalTime.textContent = totalDuration + 'ms';
          testDuration.textContent = totalDuration + 'ms';
          lastCheck.textContent = now();
          
          switch (finalResult) {
            case 'playable':
              setStatus('Video o\'qilishi mumkin ‚úÖ', 'good');
              setHttpInfo(`<span class="badge good">Mavjud va o'qilishi mumkin</span>`);
              setProbeResult(`Video brauzer tomonidan o'qilishi mumkin.`);
              setRecommend(`Bu URL to'g'ri ishlaydi va video o'qilishi mumkin.`);
              break;
            case 'available':
              setStatus('Mavjud, lekin test qilinmadi', 'good');
              setHttpInfo(`<span class="badge good">Mavjud</span>`);
              setProbeResult(`Fayl mavjud, lekin video test o'tmadi.`);
              setRecommend(`Fayl mavjud, lekin CORS yoki boshqa cheklovlar tufayli test qilish mumkin emas.`);
              break;
            case 'blocked':
              setStatus('Bloklangan yoki cheklangan', 'bad');
              setHttpInfo(`<span class="badge bad">Bloklangan</span>`);
              setProbeResult(`Server so'rovlarni rad etmoqda (403 yoki boshqa xatolar).`);
              setRecommend(`Proxy server orqali urinib ko'ring yoki CORS sozlamalarini tekshiring.`);
              break;
            default:
              setStatus('Noma\'lum holat', 'warn');
              setHttpInfo(`<span class="badge warn">Noma\'lum</span>`);
              setProbeResult(`Hech qanday aniq natija olinmadi.`);
              setRecommend(`Batafsil tekshirish uchun server proxy ishlating.`);
          }
          
          // Record statistics
          recordCheck(finalResult === 'playable' || finalResult === 'available', totalDuration);
          
        } catch (e) {
          appendLog(`Umumiy xato: ${e.message}`, 'error');
          setStatus('Xato yuz berdi', 'bad');
        } finally {
          setTimeout(() => {
            progressBar.style.display = 'none';
          }, 1000);
          
          isChecking = false;
          checkBtn.disabled = false;
          checkBtn.innerHTML = 'üîç Tekshirish';
          openBtn.disabled = false;
          downloadBtn.disabled = false;
        }
      }
      
      // Event listeners
      checkBtn.addEventListener('click', async () => {
        const val = urlInput.value.trim();
        if (!val) { 
          alert('Iltimos, URL manzilini kiriting');
          urlInput.focus();
          return;
        }
        
        // Validate URL
        try {
          new URL(val);
        } catch {
          alert('Noto\'g\'ri URL format. Iltimos, to\'liq URL kiriting (masalan: https://example.com/video.mp4)');
          urlInput.focus();
          return;
        }
        
        await performChecks(val);
      });
      
      openBtn.addEventListener('click', () => {
        const val = urlInput.value.trim();
        if (val) window.open(val, '_blank', 'noopener,noreferrer');
      });
      
      downloadBtn.addEventListener('click', () => {
        const val = urlInput.value.trim();
        if (!val) return;
        const a = document.createElement('a');
        a.href = val;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.download = '';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
      
      copyLog.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(logs.textContent);
          appendLog('Loglar nusxalandi', 'success');
        } catch {
          appendLog('Nusxalash imkonsiz', 'error');
        }
      });
      
      clearLog.addEventListener('click', () => { 
        logs.textContent = 'Loglar tozalandi.\n';
        appendLog('Loglar tozalandi', 'info');
      });
      
      exportLog.addEventListener('click', () => {
        const content = logs.textContent;
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `video-checker-logs-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        appendLog('Loglar export qilindi', 'success');
      });
      
      testProxy.addEventListener('click', async () => {
        if (!proxyUrl.value.trim()) {
          alert('Proxy URL ni kiriting');
          return;
        }
        
        try {
          const testUrl = 'https://httpbin.org/status/200';
          const proxyTestUrl = proxyUrl.value.trim() + encodeURIComponent(testUrl) + '&_method=HEAD';
          
          appendLog('Proxy test boshlandi...');
          const response = await fetch(proxyTestUrl, { method: 'GET' });
          
          if (response.ok) {
            appendLog('Proxy muvaffaqiyatli ishlayapti', 'success');
          } else {
            appendLog(`Proxy javob bermadi: ${response.status}`, 'error');
          }
        } catch (e) {
          appendLog(`Proxy test xato: ${e.message}`, 'error');
        }
      });
      
      saveSettings.addEventListener('click', () => {
        saveSettingsToStorage();
      });
      
      urlInput.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter') checkBtn.click();
      });
      
      // Load settings on startup
      loadSettings();
      proxyUrl.value = proxyUrl.value || 'http://localhost:3000/proxy?url=';
      
      // Auto-focus URL input
      urlInput.focus();
      
    })();
  </script>
</body>
</html>
